{% extends "layout.html" %}
{% block title %}{{ 'Nuovo' if is_new else 'Modifica' }} Workflow{% endblock %}

{% block content %}
<form method="post">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>{{ 'Nuovo' if is_new else 'Modifica' }} Workflow</h2>
        <div>
            <a href="{{ url_for('help_plugins') }}" class="btn btn-info me-2">
                Guida trigger/action
            </a>
            <a href="{{ url_for('index') }}" class="btn btn-secondary">
                <i class="bi bi-x-lg"></i> Annulla
            </a>
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-save"></i> Salva Workflow
            </button>
        </div>
    </div>

    {% if error %}
    <div class="alert alert-danger">{{ error }}</div>
    {% endif %}

    <!-- Global Settings -->
    <div class="card">
        <div class="card-header">Impostazioni Globali</div>
        <div class="card-body">
            <div class="mb-3">
                <label for="admin_email" class="form-label">Email Amministratore</label>
                <input type="email" class="form-control" id="admin_email" name="admin_email" value="{{ cfg.admin_email or '' }}">
            </div>
            <h6>Configurazione SMTP</h6>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="smtp_host" class="form-label">Host SMTP</label>
                    <input type="text" class="form-control" id="smtp_host" name="smtp_host" value="{{ cfg.get('smtp', {}).get('host', '') }}">
                </div>
                <div class="col-md-6 mb-3">
                    <label for="smtp_port" class="form-label">Porta SMTP</label>
                    <input type="number" class="form-control" id="smtp_port" name="smtp_port" value="{{ cfg.get('smtp', {}).get('port', '') }}">
                </div>
                <div class="col-md-6 mb-3">
                    <label for="smtp_username" class="form-label">Username SMTP</label>
                    <input type="text" class="form-control" id="smtp_username" name="smtp_username" value="{{ cfg.get('smtp', {}).get('username', '') }}">
                </div>
                 <div class="col-md-6 mb-3">
                    <label for="smtp_password" class="form-label">Password SMTP</label>
                    <input type="password" class="form-control" id="smtp_password" name="smtp_password" value="{{ cfg.get('smtp', {}).get('password', '') }}">
                </div>
            </div>
        </div>
    </div>

    <!-- Workflow Details -->
    <div class="card">
        <div class="card-header">Dettagli Workflow</div>
        <div class="card-body">
            <div class="mb-3">
                <label for="id" class="form-label">ID Workflow</label>
                <input type="text" class="form-control" id="id" name="id" value="{{ wf.id }}" required>
            </div>
        </div>
    </div>

    <!-- Trigger summary card -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            Trigger
            <div>
                {% if not is_new %}
                <a href="{{ url_for('edit_trigger_route', wf=index) }}" class="btn btn-sm btn-outline-primary">Modifica</a>
                {% endif %}
                <button type="button" class="btn btn-sm btn-danger" onclick="clearTrigger()">Cancella</button>
            </div>
        </div>
        <div class="card-body" id="trigger-summary"></div>
    </div>
    <input type="hidden" name="trigger" id="trigger-input" value='{{ wf.trigger|tojson }}'>

    <!-- Actions summary cards -->
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h3>Azioni</h3>
        <button type="button" class="btn btn-success" onclick="addAction()">
            <i class="bi bi-plus-circle"></i> Aggiungi Azione
        </button>
    </div>
    <div id="actions-container"></div>
    <input type="hidden" name="actions" id="actions-input" value='{{ wf.get("actions", [])|tojson }}'>
</form>

{% endblock %}

{% block scripts %}
<script>
    const isNew = {{ 'true' if is_new else 'false' }};
    let trigger = JSON.parse(document.getElementById('trigger-input').value || '{}');
    let actions = JSON.parse(document.getElementById('actions-input').value || '[]');

    {% if not is_new %}
    const editActionBase = "{{ url_for('edit_action_route', wf=index, idx=0)[:-1] }}";
    {% endif %}

    function renderTrigger() {
        const summary = document.getElementById('trigger-summary');
        if (trigger.type) {
            let html = `<strong>${trigger.type}</strong>`;
            const params = Object.assign({}, trigger);
            delete params.type;
            const entries = Object.entries(params);
            if (entries.length) {
                html += '<ul class="mb-0">' + entries.map(([k,v]) => `<li>${k}: ${v}</li>`).join('') + '</ul>';
            }
            summary.innerHTML = html;
        } else {
            summary.innerHTML = '<em>Nessun trigger configurato</em>';
        }
        document.getElementById('trigger-input').value = JSON.stringify(trigger);
    }

    function clearTrigger() {
        trigger = {};
        renderTrigger();
    }

    function renderActions() {
        const container = document.getElementById('actions-container');
        container.innerHTML = '';
        actions.forEach((action, idx) => {
            const params = action.params || {};
            const entries = Object.entries(params);
            const paramsHtml = entries.length ? '<ul class="mb-0">' + entries.map(([k,v]) => `<li>${k}: ${v}</li>`).join('') + '</ul>' : '';
            const card = document.createElement('div');
            card.className = 'card mb-2';
            let buttons = `<button type="button" class="btn btn-sm btn-danger" onclick="removeAction(${idx})">Cancella</button>`;
            if (!isNew) {
                buttons = `<a href="${editActionBase}${idx}" class="btn btn-sm btn-outline-primary me-2">Modifica</a>` + buttons;
            }
            card.innerHTML = `<div class="card-body d-flex justify-content-between align-items-center">
                <div><strong>${action.type || '(non configurata)'}</strong>${paramsHtml}</div>
                <div>${buttons}</div>
            </div>`;
            container.appendChild(card);
        });
        document.getElementById('actions-input').value = JSON.stringify(actions);
    }

    function addAction() {
        actions.push({type: '', params: {}});
        renderActions();
    }

    function removeAction(idx) {
        actions.splice(idx, 1);
        renderActions();
    }

    renderTrigger();
    renderActions();
</script>
{% endblock %}
